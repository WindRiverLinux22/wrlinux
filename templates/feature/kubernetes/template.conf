DISTRO_FEATURES:append = " virtualization"
WRTEMPLATE_CLASSE:append = " meta-virt-k8s-cfg"

# kubernetes
PNWHITELIST:virtualization-layer += 'kubernetes'
PNWHITELIST:networking-layer += 'ebtables'
PNWHITELIST:virtualization-layer += 'cni'
# k8s current can only be built with go 1.12
PNWHITELIST:virtualization-layer += " \
    go \
    go-native \
    go-runtime \
    go-cross-${TUNE_PKGARCH} \
    go-cross-canadian-${TRANSLATED_TARGET_ARCH} \
    go-crosssdk-${SDK_SYS} \
"


# docker
PNWHITELIST:virtualization-layer += 'docker'
PNWHITELIST:networking-layer += 'bridge-utils'
PNWHITELIST:virtualization-layer += 'compose-file'
PNWHITELIST:virtualization-layer += 'containerd-opencontainers'
PNWHITELIST:virtualization-layer += 'go-capability'
PNWHITELIST:virtualization-layer += 'go-cli'
PNWHITELIST:virtualization-layer += 'go-connections'
PNWHITELIST:virtualization-layer += 'go-context'
PNWHITELIST:virtualization-layer += 'go-dbus'
PNWHITELIST:virtualization-layer += 'go-distribution'
PNWHITELIST:virtualization-layer += 'go-fsnotify'
PNWHITELIST:virtualization-layer += 'go-logrus'
PNWHITELIST:virtualization-layer += 'go-mux'
PNWHITELIST:virtualization-layer += 'go-patricia'
PNWHITELIST:virtualization-layer += 'go-pty'
PNWHITELIST:virtualization-layer += 'go-systemd'
PNWHITELIST:virtualization-layer += 'grpc-go'
PNWHITELIST:virtualization-layer += 'notary'
PNWHITELIST:virtualization-layer += 'runc-docker'
PNWHITELIST:virtualization-layer += 'tini'

# conntrack-tools
PNWHITELIST:networking-layer += 'conntrack-tools'
PNWHITELIST:networking-layer += 'libnetfilter-conntrack'
PNWHITELIST:networking-layer += 'libnetfilter-cthelper'
PNWHITELIST:networking-layer += 'libnetfilter-cttimeout'
PNWHITELIST:networking-layer += 'libnetfilter-queue'
PNWHITELIST:networking-layer += 'libnfnetlink'

# x86 is offically not supported by kubernetes, but wrlinux defaults to enable multilib for x86-64
NON_MULTILIB_RECIPES:append:x86-64 = " kubernetes"

# k8s uses systemd cgroup driver as the prefered cgroup driver, enable such support in runc
PACKAGECONFIG:pn-runc-docker = ""
PACKAGECONFIG:pn-runc-docker = "${@bb.utils.contains('DISTRO_FEATURES', 'seccomp', 'seccomp', '', d)} \
                                ${@bb.utils.contains('DISTRO_FEATURES', 'selinux', 'selinux', '', d)} \
	                       "

# Set preferred version to ensure things work well
PREFERRED_VERSION_cni = "0.7.1"
PREFERRED_VERSION_docker = "20.10.12"
PREFERRED_VERSION_kubernetes = "1.22.1"

# wrlinux additional kubernetes configuration path
# The config fragment is set according to cmd/kubeadm/app/util/system/types_unix.go in kubernetes source
EXTRA_KERNEL_FILES =. "${LAYER_PATH_wrlinux}/templates/feature/kubernetes/files:"
EXTRA_KERNEL_SRC_URI += "file://wr-kubernetes.cfg"
